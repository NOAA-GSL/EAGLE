#!/usr/bin/env bash

set -aeu

INSTALLDIR=$PWD/eagle

conda_activate() {
  local env=$1
  source $INSTALLDIR/etc/profile.d/conda.sh
  conda activate $env
}

conda_create() {
  local name=$1
  conda_activate base
  conda create -y -q -n $*
  (
    conda_activate $name
    dir_activate=$CONDA_PREFIX/etc/conda/activate.d
    mkdir -pv $dir_activate
    cat <<EOF >$dir_activate/eagle.sh
if [[ -v XDG_CACHE_HOME ]]; then
  export EAGLE_OLD_XDG_CACHE_HOME=\$XDG_CACHE_HOME
fi
export XDG_CACHE_HOME=\$CONDA_PREFIX/cache
EOF
    dir_deactivate=$CONDA_PREFIX/etc/conda/deactivate.d
    mkdir -pv $dir_deactivate
    cat <<EOF >$dir_deactivate/eagle.sh
if [[ -v EAGLE_OLD_XDG_CACHE_HOME ]]; then
  export XDG_CACHE_HOME=\$EAGLE_OLD_XDG_CACHE_HOME
  unset EAGLE_OLD_XDG_CACHE_HOME
else
  unset XDG_CACHE_HOME
fi
EOF
  )
}

conda_create_anemoi() {
  local name=anemoi
  msg Creating environment: $name
  (
    cudamod=$(module --terse spider cuda | grep -v "^$" | tail -n1)
    test -z "${cudamod:-}" && echo "No CUDA module found" && exit 1
    module load $cudamod
    cu=$(nvcc --version | grep release | sed -E 's/^.*release ([0-9]+).*/\1/')
    CONDA_OVERRIDE_CUDA=$cu conda_create $name flash-attn=2.8.* python=3.12
    conda_activate $name
    packages=(
      anemoi-datasets==0.5.*
      anemoi-graphs==0.6.*
      anemoi-inference==0.6.*
      anemoi-models==0.8.*
      anemoi-training==0.5.*
    )
    pip install ${packages[*]}
    cat <<EOF >>$CONDA_PREFIX/etc/conda/activate.d/eagle.sh
modules="\$(module --terse list | grep -v 'No modules loaded' | tr '\n' ' ')"
if [[ -n "\$modules" ]]; then
  export EAGLE_OLD_MODULES="\$modules"
fi
module purge
module load $cudamod
EOF
    cat <<EOF >>$CONDA_PREFIX/etc/conda/deactivate.d/eagle.sh
module purge
if [[ -v EAGLE_OLD_MODULES ]]; then
  module load \$EAGLE_OLD_MODULES
  unset EAGLE_OLD_MODULES
fi
EOF
  )
}

conda_create_data() {
  local name=data
  msg Creating environment: $name
  conda_create $name ufs2arco=0.17.*
}

conda_create_vx() {
  local name=vx
  msg Creating environment: $name
  conda_create $name -c ufs-community -c paul.madden python=3.13 wxvx=0.3.*
}

conda_create_workflow() {
  local name=workflow
  msg Creating environment: $name
  conda_create $name -c ufs-community uwtools=2.12.*
}

conda_install() {
  msg Installing conda
  local ver=25.9.1-0
  local installer=Miniforge3-$ver-Linux-$(uname -p).sh
  local url=https://github.com/conda-forge/miniforge/releases/download/$ver/$installer
  wget -nv $url
  bash $installer -bfp $INSTALLDIR
  rm -v $installer
}

msg() {
  echo -e "\n=> $*\n"
}

conda_install
conda_create_anemoi
conda_create_data
conda_create_vx
conda_create_workflow

msg Done
